// prompts.js — 全フェーズのプロンプトテンプレート

const { GUIDELINE_FULL } = require('./guideline');

/**
 * Phase 1: 分割精読プロンプト
 * 各チャンクごとに構造要素を強制抽出する
 */
function buildExtractionPrompt({ protagonist, genre, theme, symbols, keyCharacters, chunkLabel, chunkText, totalChunks, chunkIndex }) {
  return `あなたは物語構造分析の最高精度の専門家です。
以下の物語テキスト（${chunkLabel}）を一行一行精読し、主人公「${protagonist}」の視点から構造要素を網羅的に抽出してください。

【重要な注意事項】
- 絶対に要約モードに入らないでください。個々のセリフや一文レベルの描写が構造的根拠になりえます。
- 「該当なし」と書く場合も、なぜ該当しないかの理由を必ず付記してください。
- 原文からの直接引用を各項目で最低1箇所は含めてください。

【作品メタ情報】
- ジャンル：${genre}
- 主題の問い（仮説）：${theme}
- 追跡すべき象徴・モチーフ：${symbols}
- 主要キャラクター：${keyCharacters}
- 全${totalChunks}チャンク中の第${chunkIndex}チャンク

【各話について以下を必ず記入してください】

話ごとに以下のフォーマットで出力：

=== 第○話 ===
■ ${protagonist}の行動：（能動的か受動的かを明記。「〜した」形式で具体的に）
■ ${protagonist}の内面変化：（心理描写・独白・地の文から読み取れる感情の動き）
■ ${protagonist}の選択（あれば）：（何を選び、何を選ばなかったか。不可逆性の有無）
■ 主要キャラとの関係性変化：（距離感の増減、信頼の変化、力関係の変動）
■ 象徴・モチーフ出現：（${symbols} の出現箇所と文脈。なければ「出現なし」と理由）
■ 構造ポイント候補：（SL Score 14項目のどれに該当しうるか。複数可。根拠を付記）
  - 候補項目名：
  - 根拠となる原文引用：「」
  - 構造的理由：
■ 伏線の提示 or 回収：（新たに張られた伏線、過去の伏線の回収。なければ「なし：理由」）
■ サブプロットの進行：（本筋以外の展開の進捗。本筋との合流可能性を付記）
■ 特記事項：（上記に収まらない構造的に重要な観察）

【物語テキスト】
${chunkText}`;
}

/**
 * Phase 2: 構造マッピングプロンプト
 * 全チャンクの抽出結果を14項目に対応付ける
 */
function buildMappingPrompt({ protagonist, genre, theme, symbols, allExtractions }) {
  return `あなたはSL Score Ver.13.1Aに基づく構造評価の専門家です。
以下の全話構造抽出結果を精査し、14項目への対応付け（構造マッピング）を行ってください。

【重要な注意事項】
- 「派手なイベント」と「構造的転換点」を厳密に区別してください。
- TP1・TP2は必ず主人公の能動的選択でなければなりません。外的事件は不可。
- 候補が複数ある場合はすべて列挙した上で、最も構造的に強いものを選定してください。
- 選定理由は必ずガイドラインの評価基準を参照して記述してください。

【作品メタ情報】
- 主人公：${protagonist}
- ジャンル：${genre}
- 主題の問い：${theme}
- 象徴軸：${symbols}

【ガイドライン（14項目定義）】
${GUIDELINE_FULL}

【全話構造抽出結果】
${allExtractions}

【出力形式】
各14項目について以下を記述：

=== [項目番号]. [項目名] ===
■ 該当話数：第○話（〜第○話）
■ 該当場面の要約：（100字以内）
■ 根拠となる原文引用：「」
■ 構造的根拠：（なぜこの場面がこの項目に該当するか。ガイドラインの基準を参照）
■ 候補が他にあった場合：（他候補とその不採用理由）
■ 前後の項目との因果接続：（前の項目からどう因果的につながるか、次の項目へどう接続するか）

=== 横断検証 ===
■ 因果チェーン検証：
  Opening → II → TP1 → PP1 → Midpoint → PP2 → AllIsLost → 再起 → TP2 → Climax → Final
  各接続部の因果関係を検証し、断絶がある場合は指摘

■ 象徴軸の一貫性：
  「${symbols}」が各構造ポイントでどう機能しているかを一覧化

■ サブプロットの合流状況：
  各サブプロットが本筋のどの構造ポイントに合流するかを整理

■ 未回収の伏線：
  提示されたが回収されていない伏線のリスト

■ 構造上の特記事項：
  マッピング過程で気づいた構造的な強み・課題・特異点`;
}

/**
 * Phase 3: 採点プロンプト
 * マッピング結果に基づき14項目を採点
 */
function buildScoringPrompt({ protagonist, genre, theme, symbols, mappingResult }) {
  return `あなたはSL Score Ver.13.1Aの公式採点官です。
以下の構造マッピング結果に基づき、14項目を厳密に採点してください。

【採点の鉄則】
1. 各項目の点数は、ガイドラインの「点数段階」に厳密に準拠すること
2. 「加点対象」「減点対象」を必ず確認し、該当する要素を明記すること
3. 採点理由には必ず原文引用を含めること（引用なき採点は無効）
4. 感情的印象や演出の巧みさではなく、構造的機能のみを評価すること
5. 迷った場合は厳しい方の点数を採用すること

【作品メタ情報】
- 主人公：${protagonist}
- ジャンル：${genre}
- 主題の問い：${theme}
- 象徴軸：${symbols}

【ガイドライン】
${GUIDELINE_FULL}

【構造マッピング結果】
${mappingResult}

【出力形式】
各14項目について以下のフォーマットで記述：

### [番号]. [項目名]：[点数（小数点第1位）]

**採点理由**：（200字以上。構造的根拠を明記）

**原文引用**：「」

**加点要素**：
- 

**減点要素**：
- （なければ「特になし」）

---

### 型・ケース分類

**TP2型分類**：A型 / B型 / C型 / D型（理由を付記）
**Climax型分類**：A型 / B型 / C型 / D型（理由を付記）
**ケース分類**：Case A〜K（理由を付記）

---

### 構造上の強み（3点以上記述）

1. 
2. 
3. 

### 構造上の課題（1点以上記述）

1. 

---

### 三条件チェック表

| No. | 項目名 | 主題提示の成立 | 論理的因果構造 | 意味の責任実行・収束 |
|-----|--------|---------------|---------------|---------------------|
| 01 | Opening Image | ○/△/× 理由 | ○/△/× 理由 | ○/△/× 理由 |
（14項目すべて記入）

---

### 採点一覧

| No. | 項目 | 点数 |
|-----|------|------|
| 01 | オープニングイメージ | |
| 02 | セットアップ | |
| 03 | インサイティング・インシデント | |
| 04 | ターニングポイント1 | |
| 05 | サブプロット | |
| 06 | お楽しみ要素 | |
| 07 | ピンチポイント1 | |
| 08 | ミッドポイント | |
| 09 | ピンチポイント2 | |
| 10 | すべてを失う | |
| 11 | 再起のきっかけ | |
| 12 | ターニングポイント2 | |
| 13 | クライマックス | |
| 14 | 結末 | |

**構成点（W1）平均：** /10`;
}

/**
 * Phase 4: 逆方向検証プロンプト（見落とし検出）
 */
function buildVerificationPrompt({ protagonist, theme, symbols, scoringResult, originalText }) {
  return `あなたはSL Score Ver.13.1Aの品質監査官です。
以下の採点結果に対して、「見落とし」「誤認」「過大評価」「過小評価」の可能性を厳密に検証してください。

【検証の観点】
1. TP1と判定した箇所より前に、もっと構造的に強い選択場面がないか
2. Midpointと判定した箇所以外に、構造転換として機能している場面がないか
3. TP2と判定した箇所は本当に主人公の能動的選択か（外的要因ではないか）
4. Climaxにおけるデウス・エクス・マキナの見落としがないか
5. サブプロットで本筋に合流していないものがないか
6. 中盤（全体の30%〜70%区間）に位置する構造要素が適切に評価されているか
7. 象徴軸が途切れている箇所がないか
8. 「派手なイベント」を構造的転換点と誤認していないか
9. 点数が一律に高すぎる/低すぎる傾向がないか（sweet spot bias の検出）
10. 原文引用が実際の構造的根拠として十分か（引用があっても根拠が弱いケース）

【作品情報】
- 主人公：${protagonist}
- 主題の問い：${theme}
- 象徴軸：${symbols}

【現在の採点結果】
${scoringResult}

【出力形式】

=== 検証結果 ===

■ 見落としの可能性：
（項目ごとに、見落としている可能性のある場面を指摘）

■ 誤認の可能性：
（構造ポイントの誤判定の可能性を指摘）

■ 過大評価の可能性：
（点数が高すぎる可能性のある項目とその理由）

■ 過小評価の可能性：
（点数が低すぎる可能性のある項目とその理由）

■ 修正提案：
（上記を踏まえた具体的な修正案。点数変更の場合は変更後の点数と理由）

■ 検証後の確信度：
（各項目について、現在の採点に対する確信度をA/B/Cで表記）
A：確信あり（変更不要）
B：やや不確実（再確認推奨）
C：要再検討（重大な見落とし・誤認の可能性）`;
}

module.exports = {
  buildExtractionPrompt,
  buildMappingPrompt,
  buildScoringPrompt,
  buildVerificationPrompt
};
