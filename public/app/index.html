<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SL Score 構造分析ツール</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="app">
    <!-- Header -->
    <header class="header">
      <div class="header-inner">
        <div class="logo">
          <span class="logo-mark">SL</span>
          <div class="logo-text">
            <h1>Structural Logical Score</h1>
            <p>構造論理点 分析ツール <span class="version">Ver.13.1A</span></p>
          </div>
        </div>
        <div class="header-right">
          <div class="header-badge">ガイドライン内蔵</div>
          <div class="user-info" id="userInfo">
            <span id="userDisplay" class="user-name"></span>
            <button class="btn btn-sm" id="btnAdmin" onclick="toggleAdmin()" style="display:none">管理</button>
            <button class="btn btn-sm" onclick="doLogout()">ログアウト</button>
          </div>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main class="main">
      <!-- Step 1: 設定 -->
      <section class="panel" id="panel-config">
        <div class="panel-header">
          <span class="step-num">01</span>
          <h2>作品情報・設定</h2>
        </div>
        <div class="panel-body">
          <div class="form-grid">
            <div class="form-group">
              <label for="model">モデル</label>
              <select id="model">
                <option value="gemini-2.0-flash">Gemini 2.0 Flash（推奨・高速・無料）</option>
                <option value="gemini-2.5-flash-preview-05-20">Gemini 2.5 Flash Preview（高精度・無料）</option>
                <option value="gemini-1.5-pro">Gemini 1.5 Pro（大容量）</option>
              </select>
            </div>
            <div class="form-group">
              <label for="protagonist">主人公／視点主 <span class="required">*</span></label>
              <input type="text" id="protagonist" placeholder="例：咲夜">
            </div>
            <div class="form-group">
              <label for="genre">ジャンル</label>
              <input type="text" id="genre" placeholder="例：ブロマンス（恋愛のないバディもの）">
            </div>
            <div class="form-group full-width">
              <label for="theme">主題の問い（仮説）</label>
              <input type="text" id="theme" placeholder="例：煙の壁で距離を保つ男が、壁を捨てて隣に立つ覚悟を持てるか">
              <small>不明な場合は空欄でOK。Phase 2で自動推定されます</small>
            </div>
            <div class="form-group">
              <label for="symbols">追跡する象徴・モチーフ</label>
              <input type="text" id="symbols" placeholder="例：タバコ、火、心臓、距離">
            </div>
            <div class="form-group">
              <label for="keyCharacters">主要キャラクター</label>
              <input type="text" id="keyCharacters" placeholder="例：優真、夕立、利人、龍崎">
            </div>
          </div>
          <div class="form-group full-width">
            <label class="checkbox-label">
              <input type="checkbox" id="skipVerification">
              Phase 4（逆方向検証）をスキップ（処理時間短縮）
            </label>
          </div>
        </div>
      </section>

      <!-- Step 2: テキスト入力 -->
      <section class="panel" id="panel-text">
        <div class="panel-header">
          <span class="step-num">02</span>
          <h2>作品テキスト</h2>
          <div class="panel-actions">
            <button class="btn btn-sm" id="btnPreview" onclick="previewChunks()">分割プレビュー</button>
            <span id="charCount" class="char-count">0文字</span>
          </div>
        </div>
        <div class="panel-body">
          <textarea id="storyText" placeholder="作品のテキストをここに貼り付けてください。&#10;&#10;10万文字超でも対応。自動的にチャプター単位で分割し、段階的に精読します。"></textarea>
          <div id="chunkPreview" class="chunk-preview hidden"></div>
        </div>
      </section>

      <!-- 実行ボタン -->
      <div class="action-bar">
        <button class="btn btn-primary btn-lg" id="btnAnalyze" onclick="startAnalysis()">
          <span class="btn-icon">▶</span>
          分析開始
        </button>
        <p class="action-note">Phase 1〜4を自動実行し、最終採点結果を出力します</p>
      </div>

      <!-- Step 3: 進行状況 -->
      <section class="panel hidden" id="panel-progress">
        <div class="panel-header">
          <span class="step-num">03</span>
          <h2>分析進行状況</h2>
          <span id="elapsedTime" class="elapsed">00:00</span>
        </div>
        <div class="panel-body">
          <div class="phase-tracker">
            <div class="phase-item" id="phase-1">
              <div class="phase-indicator"></div>
              <div class="phase-info">
                <h3>Phase 1：分割精読</h3>
                <p class="phase-desc">各チャンクを精読し、構造要素を抽出</p>
                <div class="progress-bar"><div class="progress-fill" id="progress-1"></div></div>
              </div>
            </div>
            <div class="phase-item" id="phase-2">
              <div class="phase-indicator"></div>
              <div class="phase-info">
                <h3>Phase 2：構造マッピング</h3>
                <p class="phase-desc">14項目への対応付け・因果検証</p>
                <div class="progress-bar"><div class="progress-fill" id="progress-2"></div></div>
              </div>
            </div>
            <div class="phase-item" id="phase-3">
              <div class="phase-indicator"></div>
              <div class="phase-info">
                <h3>Phase 3：採点</h3>
                <p class="phase-desc">ガイドライン準拠の厳密採点</p>
                <div class="progress-bar"><div class="progress-fill" id="progress-3"></div></div>
              </div>
            </div>
            <div class="phase-item" id="phase-4">
              <div class="phase-indicator"></div>
              <div class="phase-info">
                <h3>Phase 4：逆方向検証</h3>
                <p class="phase-desc">見落とし・誤認・バイアス検出</p>
                <div class="progress-bar"><div class="progress-fill" id="progress-4"></div></div>
              </div>
            </div>
          </div>
          <div id="logContainer" class="log-container">
            <div id="logContent"></div>
          </div>
        </div>
      </section>

      <!-- Step 4: 結果 -->
      <section class="panel hidden" id="panel-results">
        <div class="panel-header">
          <span class="step-num">04</span>
          <h2>採点結果</h2>
          <div class="panel-actions">
            <button class="btn btn-sm" onclick="copyResults()">結果をコピー</button>
            <button class="btn btn-sm" onclick="downloadResults()">Markdownで保存</button>
          </div>
        </div>
        <div class="panel-body">
          <!-- スコアサマリー -->
          <div id="scoreSummary" class="score-summary"></div>

          <!-- タブ切替 -->
          <div class="result-tabs">
            <button class="tab active" onclick="switchTab('scoring')">採点結果</button>
            <button class="tab" onclick="switchTab('mapping')">構造マッピング</button>
            <button class="tab" onclick="switchTab('extraction')">精読データ</button>
            <button class="tab" onclick="switchTab('verification')">検証結果</button>
          </div>

          <div id="resultContent" class="result-content"></div>
        </div>
      </section>
    </main>

    <!-- Admin Panel (Modal) -->
    <div class="modal-overlay hidden" id="adminModal">
      <div class="modal">
        <div class="modal-header">
          <h2>ユーザー管理</h2>
          <button class="btn btn-sm" onclick="toggleAdmin()">✕ 閉じる</button>
        </div>
        <div class="modal-body">
          <div id="adminStatus" style="margin-bottom:16px;font-size:13px;color:var(--text-dim)"></div>

          <h3 style="font-size:14px;margin-bottom:12px;">ユーザー追加</h3>
          <div class="form-grid" style="margin-bottom:20px;">
            <div class="form-group">
              <label>ユーザー名</label>
              <input type="text" id="newUsername" placeholder="英数字">
            </div>
            <div class="form-group">
              <label>表示名</label>
              <input type="text" id="newDisplayName" placeholder="任意">
            </div>
            <div class="form-group">
              <label>パスワード</label>
              <input type="password" id="newPassword" placeholder="6文字以上">
            </div>
            <div class="form-group" style="justify-content:flex-end;">
              <button class="btn btn-primary" onclick="addNewUser()">追加</button>
            </div>
          </div>

          <h3 style="font-size:14px;margin-bottom:12px;">登録ユーザー</h3>
          <div id="userList"></div>
        </div>
      </div>
    </div>

    <footer class="footer">
      <p>SL Score ガイドライン Ver.13.1A 内蔵｜Anthropic Claude API使用</p>
    </footer>
  </div>
  <script src="app.js"></script>
</body>
</html>
